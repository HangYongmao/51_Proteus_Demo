//*************************************************************************************************
//*************************************************************************************************
//**<程序名>：键盘控制直流电机运转。													 		 **
//**<功能>：通过按键控制直流电机运转并在LCD上显示运行状态。										 **
//**<作者>：LastRitter																			 **
//**<完成时间>：2007年8月8日																	 **
//**<联系方式>：E-Mail:superyongzhe@163.com;QQ:314665354。										 **
//*************************************************************************************************
//*************************************************************************************************
#include "includes.h"


#define TIME0H 0xFF
#define TIME0L 0x9C		//定时器0溢出时间：0.1ms


#define TIME1H 0x3C
#define TIME1L 0xB0		//定时器1溢出时间：50ms



//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<PWM调制计数>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
unsigned char uc_MoCount=0;
unsigned char uc_MoChange=128;

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<防抖动标志>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
bit b_KeyShock=0;	  				//键盘防抖动标志位。
									//当按键中断产生时，首先判断此位。
									//0--执行键盘扫描及键码处理程序；1--不执行。

bit b_KillShock=0;					//防抖标志清除位：0--不清除；1--清除。

unsigned char uc_KillCount=1;		//抖动标志清除计数，使用定时器1。


//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<键盘扫描开启标志>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
bit b_KeyScan=0;					//0--不扫描；
									//1--扫描。



void main()
{
	vdInitialize();

	vWriteCMD(0x80);
	vShowChar("Motor Run Status");
	vWriteCMD(0xC4);
	vShowChar("Stop");
	vWriteCMD(0xCC);
	vShowNumber(uc_MoChange);

	SCANPORT=0x0F;

	MOTORPORT=MO_STOP;
	
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<外部中断0，用于开启键盘扫描及键码处理标志>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	IT0=1;			 //	中断方式：下降沿。
	EX0=1;			 //	开启外部中断。

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<定时器0，定时器0中断，用于PWM调制计数 >>>>>>>>>>>>>>>>>>>>>>>>
	TMOD=0x11;
	
	TH0=TIME0H;
	TL0=TIME0L;
	TR0=1;
	ET0=1;

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<定时器1，用于防抖动标志清除 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	TH1=TIME1H;
	TL1=TIME1L;
	TR1=1;			 //开启定时器1
	ET1=1;			 //开定时器1中断


	EA=1;

	while(1)
	{
	if(b_KeyScan==1)		   //如果有按键按下，则进行按键扫描和键码处理。
		{
		b_KeyScan=0;
		vKeyProcess(ucKeyScan());
		}
	}
}

//*************************************************************************************************
//*																								  *
//*		******************************外部中断0，用于开启键盘扫描及键码处理******************	  *
//*																								  *
//*************************************************************************************************
void vINT0(void) interrupt 0
{
	if(b_KeyShock==0)
		{
			b_KeyScan=1;			//开启键盘扫描标志。
			b_KeyShock=1;			//设置防抖动标志。
		}
	else b_KeyShock=0;				//如果有抖动则不执行键扫描，恢复防抖动标志。

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<设置防抖动清除标志位 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>	
	if(b_KeyShock==1)
		b_KillShock=1;				//如果防抖动标志位开启则开启防抖动标志清除位，
									//300ms后清除防抖动标志。

}


//*************************************************************************************************
//*																								  *
//*		****************************定时器0中断，用于PWM调制计数****************************	  *
//*																								  *
//*************************************************************************************************
void vTimer0() interrupt 1
{
	
	if(uc_MoChange>128)					  //正向。
		{
		if(uc_MoCount<uc_MoChange)
			MOTORPORT=MO_COMMON;
		else
			MOTORPORT=MO_CUTOFF;
		}
	else
		{
		if(uc_MoChange<127)				 //反向。
			{
			if(uc_MoCount>uc_MoChange)
				MOTORPORT=MO_OPPOSE;
			else
				MOTORPORT=MO_CUTOFF;
			}
		else
			MOTORPORT=MO_STOP;			//停止
		}

	
	
	
	if(uc_MoCount<255)
		uc_MoCount++;
	else
		uc_MoCount=0;

	TH0=TIME0H;
	TL0=TIME0L;		
}
//*************************************************************************************************
//*																								  *
//*		****************定时器1中断，用于计时功能和防抖动标志清除以及显示报告****************	  *
//*																								  *
//*************************************************************************************************
void vTimer1(void) interrupt 3
{
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<防抖动标志清除>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	if(b_KillShock==1)
		{
		if(uc_KillCount==5)			 //当防抖动标志位为1时，计时300ms后清除抖动标志位。
			{
			b_KeyShock=0;
			b_KillShock=0;
			uc_KillCount=1;
			}
		else uc_KillCount++;
		}
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<恢复定时器1溢出时间>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	TH1=TIME1H;
	TL1=TIME1L;
} 