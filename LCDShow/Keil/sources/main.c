//*************************************************************************************************
//*************************************************************************************************
//**<程序名>：LCD显示应用																 		 **
//**<功能>：LCD显示滚动的一句话，以及键盘输入。			 										 **
//**<作者>：LastRitter																			 **
//**<完成时间>：2007年8月8日																	 **
//**<联系方式>：E-mail:superyongzhe@163.com;QQ:314665354。										 **
//*************************************************************************************************
//*************************************************************************************************

//*************************************************************************************************
//*																								  *
//*			 ******************************头文件及宏定义**************************				  *
//*																								  *
//*************************************************************************************************
#include "includes.h"

#define TIME1H 0x3C
#define TIME1L 0xB0		//定时器1溢出时间：50ms


//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<防抖动标志>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
bit b_KeyShock=0;	  				//键盘防抖动标志位。
									//当按键中断产生时，首先判断此位。
									//0--执行键盘扫描及键码处理程序；1--不执行。

bit b_KillShock=0;					//防抖标志清除位：0--不清除；1--清除。

unsigned char uc_KillCount=1;		//抖动标志清除计数，使用定时器1。


//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<键盘扫描开启标志>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
bit b_KeyScan=0;					//0--不扫描；
									//1--扫描。

extern bit b_Introduce;				//介绍关闭标志，当置零时，介绍就会停止显示。


//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<按键计数清除>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
unsigned char uc_CleanCount=0;					//清除按键计数时间计数。

extern bit b_CleanClick;						//清除按键计数标志，定义在KeyProcess.c中
												//0--不清除；
												//1--清除。
												//在定时器1中使用。

extern unsigned char uc_ClickCount;				//按键连续点击计数，定义在KeyProcess.c中。

extern unsigned char uc_KeyTemp;				//按键键码暂存，定义在KeyProcess.c中。



//*************************************************************************************************
//*																								  *
//*			  ********************************主函数******************************				  *
//*																								  *
//*************************************************************************************************
void main()
{
	P1=0x0F;
	
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<外部中断0，用于开启键盘扫描及键码处理标志>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	IT0=1;			 //	中断方式：下降沿。
	EX0=1;			 //	开启外部中断。


//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<定时器1，用于防抖动标志清除 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	TH1=TIME1H;
	TL1=TIME1L;
	TR1=1;			 //开启定时器1
	ET1=1;			 //开定时器1中断
	
	EA=1;			 //开总中断。

	vdInitialize();				//LCD初始化，相关参数在“SMC1602.h”中修改。
								//注意，初始化里省略了vWriteCMD(0x0C)，在vIntroduce()里有。

	vIntroduce();				//显示介绍。

	while(1)
	{
	if(b_KeyScan==1)		   //如果有按键按下，则进行按键扫描和键码处理。
		{
		b_KeyScan=0;
		vKeyProcess(ucKeyScan());
		}
	}
}

//*************************************************************************************************
//*																								  *
//*		******************************外部中断0，用于开启键盘扫描及键码处理******************	  *
//*																								  *
//*************************************************************************************************
void vINT0(void) interrupt 0
{
	if(b_KeyShock==0)
		{
		if(b_Introduce==0)			//此判断是为了屏蔽从介绍返回字符输入时的键盘扫描。
			{
			b_KeyScan=1;			//开启键盘扫描标志。
			b_KeyShock=1;			//设置防抖动标志。
			}
		}
	else b_KeyShock=0;				//如果有抖动则不执行键扫描，恢复防抖动标志。

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<设置防抖动清除标志位 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>	
	if(b_KeyShock==1)
		b_KillShock=1;				//如果防抖动标志位开启则开启防抖动标志清除位，
									//300ms后清除防抖动标志。

	b_Introduce=0;					//用于关闭介绍,在显示介绍时如果有案件按下，产生的中断会
} 									//把此标志置零，便可退出介绍。



//*************************************************************************************************
//*																								  *
//*		****************定时器1中断，用于计时功能和防抖动标志清除以及显示报告****************	  *
//*																								  *
//*************************************************************************************************
void vTimer1(void) interrupt 3
{
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<防抖动标志清除>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	if(b_KillShock==1)
		{
		if(uc_KillCount%5==0)			 //当防抖动标志位为1时，计时300ms后清除抖动标志位。
			{
			b_KeyShock=0;
			b_KillShock=0;
			uc_KillCount=1;
			}
		else uc_KillCount++;
		}

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<按键计数清除>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	if(b_CleanClick==1)
		{
		if(uc_CleanCount==100)
			{
			b_CleanClick=0;				 //关闭改计数。

			uc_CleanCount=1;			 //恢复计数初值。

			uc_ClickCount=1;			 //清除按键计数。

			uc_KeyTemp=0;
			}
		else
			uc_CleanCount++;
		}

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<恢复定时器1溢出时间>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	TH1=TIME1H;
	TL1=TIME1L;
}