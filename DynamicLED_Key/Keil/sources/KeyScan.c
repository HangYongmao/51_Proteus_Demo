//*************************************************************************************************
//*************************************************************************************************
//**<程序名>：键盘扫描子程序																 	 **
//**<功能>：当有外部中断0时调用此函数，使用列扫描的方式获取键码，键码由2位数字组成。高位为行号   **
//**		低位为列号。		 																 **
//*************************************************************************************************
//*************************************************************************************************


//*************************************************************************************************
//*																								  *
//*			 ******************************头文件及宏定义**************************				  *
//*																								  *
//*************************************************************************************************
#include <at89x51.h>

#define SCANPORT P2


//*************************************************************************************************
//*																								  *
//*			  ********************************全局变量******************************			  *
//*																								  *
//*************************************************************************************************
unsigned char uca_LineScan[4]={0xEF,0xDF,0xBF,0x7F};		//LINE 1 2 3 4 


//*************************************************************************************************
//*																								  *
//*			  ********************************函数实现******************************			  *
//*																								  *
//*************************************************************************************************
unsigned char ucKeyScan()
{
	unsigned char ucTemp=0;			  	//扫描状态暂存。
	unsigned char ucRow=0,ucLine=0;	    //行号，列号。

	for(ucLine=0;ucLine<4;ucLine++)		//列扫描
		{
			SCANPORT=uca_LineScan[ucLine];   //输出扫描电位。
			ucTemp=SCANPORT&0x0F;			   //输入扫描电位，并屏蔽高4位。
			if(ucTemp!=0x0F)		   //判断该列是否有按键按下，有则判断出行号。
				{
				switch(ucTemp)
					{
					case 0x0E: ucRow=10;break;
					case 0x0D: ucRow=20;break;
					case 0x0B: ucRow=30;break;
					case 0x07: ucRow=40;break;
					default:   ucRow=50;break;
					}
				break;
				}
		}
	SCANPORT=0x0F;	  				//恢复P2口。

	return ucRow+ucLine+1;			 //返回按键编码。格式为2位数，高位为行号，低位为列号。
}